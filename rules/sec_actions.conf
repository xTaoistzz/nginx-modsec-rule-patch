
# Disable modesecurity to detection-only mode 
#SecRuleEngine DetectionOnly

# 1. Override Allowed Methods to include WebDAV
SecAction \
 "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE MOVE MKCOL PROPFIND PROPPATCH COPY LOCK UNLOCK'"

# 2. Body size 
SecRequestBodyLimit 6442450944
SecRequestBodyNoFilesLimit 10485760
SecRequestBodyLimitAction ProcessPartial


# --- Targeted rule removals to reduce known false-positives ---
# Remove SSRF detection (934110) only for OnlyOffice iframe requests
SecRule REQUEST_URI "@rx /onlyofficeds/" \
 "id:900210,phase:1,pass,nolog,t:none,ctl:ruleRemoveById=934110,ctl:ruleRemoveById=949110,msg:'Disable 934110 for OnlyOffice iframe parentOrigin to avoid false positive'"

# Allow application/octet-stream uploads for our business-drive endpoints
SecRule REQUEST_URI "@beginsWith /business-drive/" \
 "id:900211,phase:1,pass,nolog,t:none,ctl:ruleRemoveById=920420,ctl:ruleRemoveById=930130,msg:'Allow rclone/application/octet-stream and .DS_Store operations on business-drive paths'"

# Allow OnlyOffice iframe navigation parameter parentOrigin containing http(s) localhost (dev environment)
#SecRule ARGS:parentOrigin "@rx ^https?://localhost" \
# "id:900212,phase:1,pass,nolog,t:none,ctl:ruleRemoveById=934110,msg:'Bypass SSRF check for parentOrigin when coming from localhost for OnlyOffice dev tooling'"


# --- WebDAV and file management path exceptions for SQL/XSS/RCE protection ---
# Disable SQL/XSS/RCE rules for WebDAV endpoints and file operations
# This maintains security for API/web endpoints while allowing file management operations

# WebDAV file operations (PROPFIND, PUT, MOVE, COPY, MKCOL, etc.)

# This rule matches requests to the "/business-drive" URI and disables several ModSecurity rules.
# Each ctl:ruleRemoveById disables a specific rule:
# - 942100: SQL Injection Attack Detected via libinjection
# - 942140: XSS Attack Detected via libinjection
# - 942230: Multiple/Obfuscated SQL Injection Detected
# - 942151: XSS Attack Detected (HTML Injection)
# - 942190: SQL Injection Attack Detected (Common Injection Testing)
# - 942270: SQL Injection Attack Detected (Blind Injection)
# - 941100: XSS Attack Detected (Basic XSS)
# - 941110: XSS Attack Detected (Script Tag)
# - 941390: XSS Attack Detected (Event Handler)
# - 930110: Remote Command Execution: Unix Command Injection
# - 930120: Remote Command Execution: Windows Command Injection
# - 932160: Remote File Inclusion Attack Detected
# - 932235: Remote File Inclusion via URL Detected
# - 933100: PHP Injection Attack Detected
 # SecRule REQUEST_METHOD "@rx ^(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK)$" \
 #  "id:900220,\
 #   phase:1,\
 #   pass,\
 #   nolog,\
 #   t:none,\
 #   ctl:ruleRemoveById=942140,\
 #   ctl:ruleRemoveById=942230,\
 #   ctl:ruleRemoveById=942151,\
 #   ctl:ruleRemoveById=941100,\
 #   ctl:ruleRemoveById=941110,\
 #   ctl:ruleRemoveById=941390,\
 #   ctl:ruleRemoveById=930110,\
 #   ctl:ruleRemoveById=930120,\
 #   ctl:ruleRemoveById=932160,\
 #   ctl:ruleRemoveById=932235,\
 #   ctl:ruleRemoveById=933100,\
 #   msg:'Disable SQL/XSS/RCE rules for WebDAV methods'"

 # SecRule REQUEST_METHOD "@rx ^(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK)$" \
 # "id:900220,\
 #  phase:1,\
 #  pass,\
 #  nolog,\
 #  t:none,\
 #  ctl:ruleRemoveTargetById=942100;REQUEST_FILENAME,\
 #  ctl:ruleRemoveTargetById=942100;REQUEST_URI,\
 #  ctl:ruleRemoveTargetById=942100;REQUEST_URI_RAW,\
 #  ctl:ruleRemoveTargetById=930110;REQUEST_FILENAME,\
 #  ctl:ruleRemoveTargetById=930110;REQUEST_URI,\
 #  ctl:ruleRemoveTargetById=930120;REQUEST_FILENAME,\
 #  ctl:ruleRemoveTargetById=930120;REQUEST_URI,\
 #  msg:'WebDAV: Exclude path-based checks only, SQL/XSS on body ACTIVE'"

# Business-drive and file management endpoints (PUT/DELETE with file paths)
 #SecRule REQUEST_URI "@rx ^/(business-drive|api/v2|uploads|downloads)" \
 #   "id:900221,\
 #    phase:1,\
 #    pass,\
 #    nolog,\
 #    t:none,\
 #    ctl:ruleRemoveById=942140,\
 #    ctl:ruleRemoveById=930110,\
 #    ctl:ruleRemoveById=930120,\
 #    ctl:ruleRemoveById=932160,\
 #    ctl:ruleRemoveById=932235,\
 #    msg:'Disable XSS/RCE rules for file management endpoints'"

SecAction \
 "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.outbound_anomaly_score_threshold=7,\
  setvar:tx.inbound_anomaly_score_threshold=7"

# Allow base64 encoded images in upload/image endpoints (data URI scheme)
# Disables false positives from legitimate base64 image uploads (data:image/png;base64,...)
#   SecRule REQUEST_URI "@rx /(?:upload|image|logo|avatar|file|attachment|set_image)" \
#    "id:900213,\
#     phase:1,\
#     pass,\
#     nolog,\
#     t:none,\
#     ctl:ruleRemoveById=932235,\
#     ctl:ruleRemoveById=941130,\
#     ctl:ruleRemoveById=941100,\
#     msg:'Allow base64 data URIs for image/file upload endpoints'"

# Disable data leakage detection for file downloads (WebDAV/file storage use case)
SecRule REQUEST_URI "@rx ^/(business-drive|downloads|extension_pdfjs|build|onlyofficeds)" \
  "id:900230,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveById=951100,\
  ctl:ruleRemoveById=951110,\
  ctl:ruleRemoveById=951120,\
  ctl:ruleRemoveById=951130,\
  ctl:ruleRemoveById=951140,\
  ctl:ruleRemoveById=951150,\
  ctl:ruleRemoveById=951160,\
  ctl:ruleRemoveById=951170,\
  ctl:ruleRemoveById=951180,\
  ctl:ruleRemoveById=951190,\
  ctl:ruleRemoveById=951200,\
  ctl:ruleRemoveById=951210,\
  ctl:ruleRemoveById=951220,\
  ctl:ruleRemoveById=951230,\
  ctl:ruleRemoveById=951240,\
  ctl:ruleRemoveById=951250,\
  ctl:ruleRemoveById=951260,\
  ctl:ruleRemoveById=952100,\
  ctl:ruleRemoveById=952110,\
  ctl:ruleRemoveById=953100,\
  ctl:ruleRemoveById=953110,\
  ctl:ruleRemoveById=953120,\
  ctl:ruleRemoveById=956100,\
  ctl:ruleRemoveById=956110,\
  ctl:ruleRemoveById=956120,\
  ctl:ruleRemoveById=956130,\
  ctl:ruleRemoveById=950100,\
  ctl:ruleRemoveById=950110,\
  ctl:ruleRemoveById=950120,\
  ctl:ruleRemoveById=950130,\
  ctl:ruleRemoveById=950140,\
  ctl:ruleRemoveById=950150,\
  ctl:ruleRemoveById=950160,\
  ctl:ruleRemoveById=950170,\
  ctl:ruleRemoveById=950180,\
  ctl:ruleRemoveById=950190,\
   msg:'Disable data leakage detection for file downloads/WebDAV'"
